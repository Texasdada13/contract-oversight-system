{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Constituent Services Portal</h1>
            <p class="text-gray-600 dark:text-gray-400">Public engagement, comments, and transparency requests</p>
        </div>
        <div class="flex space-x-3">
            <button class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                Export Report
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Open FOIA Requests</p>
            <p class="text-2xl font-bold text-blue-600">{{ stats.open_foia }}</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Public Comments (30 days)</p>
            <p class="text-2xl font-bold text-green-600">{{ stats.recent_comments }}</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Open Complaints</p>
            <p class="text-2xl font-bold text-yellow-600">{{ stats.open_complaints }}</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Avg Response Time</p>
            <p class="text-2xl font-bold text-purple-600">{{ stats.avg_response_time }} days</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Satisfaction Rate</p>
            <p class="text-2xl font-bold text-green-600">{{ "%.0f"|format(stats.satisfaction_rate) }}%</p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200 dark:border-gray-700">
        <nav class="flex space-x-8">
            <button onclick="showTab('comments')" id="tab-comments" class="tab-btn border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 py-4 px-1 font-medium">
                Public Comments
            </button>
            <button onclick="showTab('foia')" id="tab-foia" class="tab-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 py-4 px-1 font-medium">
                FOIA Requests
            </button>
            <button onclick="showTab('complaints')" id="tab-complaints" class="tab-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 py-4 px-1 font-medium">
                Citizen Complaints
            </button>
            <button onclick="showTab('feedback')" id="tab-feedback" class="tab-btn text-gray-500 hover:text-gray-700 dark:text-gray-400 py-4 px-1 font-medium">
                Feedback Dashboard
            </button>
        </nav>
    </div>

    <!-- Public Comments Tab -->
    <div id="content-comments" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Recent Public Comments</h3>
                        <select class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                            <option>All Topics</option>
                            <option>Contract Approvals</option>
                            <option>Budget Items</option>
                            <option>Policy Changes</option>
                        </select>
                    </div>

                    <div class="space-y-4">
                        {% for comment in public_comments %}
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex items-start space-x-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-bold">
                                        {{ comment.name[0] }}
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900 dark:text-white">{{ comment.name }}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">{{ comment.date }}</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full
                                    {% if comment.topic == 'Contract' %}bg-blue-100 text-blue-800
                                    {% elif comment.topic == 'Budget' %}bg-green-100 text-green-800
                                    {% elif comment.topic == 'Policy' %}bg-purple-100 text-purple-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ comment.topic }}
                                </span>
                            </div>
                            <div class="mt-3">
                                {% if comment.related_item %}
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                                    Re: <a href="{{ comment.related_item.url }}" class="text-blue-600 hover:text-blue-800">{{ comment.related_item.title }}</a>
                                </p>
                                {% endif %}
                                <p class="text-sm text-gray-700 dark:text-gray-300">{{ comment.content }}</p>
                            </div>
                            <div class="mt-3 flex items-center space-x-4">
                                <span class="px-2 py-1 text-xs rounded-full
                                    {% if comment.sentiment == 'Support' %}bg-green-100 text-green-800
                                    {% elif comment.sentiment == 'Oppose' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ comment.sentiment }}
                                </span>
                                {% if comment.response %}
                                <span class="text-xs text-green-600">Response Sent</span>
                                {% else %}
                                <button class="text-xs text-blue-600 hover:text-blue-800">Respond</button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Comment Sentiment</h3>
                    <div id="sentimentChart" class="h-48"></div>
                    <div class="mt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Support</span>
                            <span class="text-green-600 font-medium">{{ sentiment_stats.support }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Neutral</span>
                            <span class="text-gray-600 font-medium">{{ sentiment_stats.neutral }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Oppose</span>
                            <span class="text-red-600 font-medium">{{ sentiment_stats.oppose }}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Top Commented Items</h3>
                    <div class="space-y-3">
                        {% for item in top_commented %}
                        <div class="flex justify-between items-center">
                            <a href="{{ item.url }}" class="text-sm text-blue-600 hover:text-blue-800 truncate max-w-[180px]">{{ item.title }}</a>
                            <span class="text-sm font-medium text-gray-900 dark:text-white">{{ item.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOIA Requests Tab -->
    <div id="content-foia" class="tab-content hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden">
            <div class="p-6 border-b dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">FOIA/Public Records Requests</h3>
                    <div class="flex space-x-3">
                        <select class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                            <option>All Status</option>
                            <option>Open</option>
                            <option>In Progress</option>
                            <option>Completed</option>
                            <option>Denied</option>
                        </select>
                    </div>
                </div>
            </div>

            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Request ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Requestor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Description</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Received</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Due Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for request in foia_requests %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 {% if request.is_overdue %}bg-red-50 dark:bg-red-900{% endif %}">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">{{ request.id }}</td>
                        <td class="px-6 py-4">
                            <p class="text-sm text-gray-900 dark:text-white">{{ request.requestor_name }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ request.requestor_org }}</p>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400 max-w-xs truncate">{{ request.description }}</td>
                        <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">{{ request.received_date }}</td>
                        <td class="px-6 py-4">
                            <span class="text-sm {% if request.is_overdue %}text-red-600 font-medium{% else %}text-gray-600 dark:text-gray-400{% endif %}">
                                {{ request.due_date }}
                            </span>
                            {% if request.days_remaining < 3 and request.days_remaining > 0 %}
                            <span class="text-xs text-yellow-600 block">{{ request.days_remaining }} days left</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full
                                {% if request.status == 'Completed' %}bg-green-100 text-green-800
                                {% elif request.status == 'In Progress' %}bg-blue-100 text-blue-800
                                {% elif request.status == 'Open' %}bg-yellow-100 text-yellow-800
                                {% elif request.status == 'Denied' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ request.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <button class="text-blue-600 hover:text-blue-800">View</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- FOIA Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Total This Year</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ foia_stats.total_year }}</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Completed on Time</p>
                <p class="text-2xl font-bold text-green-600">{{ "%.0f"|format(foia_stats.on_time_pct) }}%</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Avg. Completion Time</p>
                <p class="text-2xl font-bold text-blue-600">{{ foia_stats.avg_days }} days</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Denial Rate</p>
                <p class="text-2xl font-bold text-red-600">{{ "%.1f"|format(foia_stats.denial_rate) }}%</p>
            </div>
        </div>
    </div>

    <!-- Citizen Complaints Tab -->
    <div id="content-complaints" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden">
                    <div class="p-6 border-b dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Open Complaints</h3>
                    </div>
                    <div class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for complaint in complaints %}
                        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-0.5 text-xs rounded-full
                                            {% if complaint.priority == 'High' %}bg-red-100 text-red-800
                                            {% elif complaint.priority == 'Medium' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-green-100 text-green-800{% endif %}">
                                            {{ complaint.priority }}
                                        </span>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">{{ complaint.id }}</span>
                                    </div>
                                    <h4 class="mt-1 font-medium text-gray-900 dark:text-white">{{ complaint.subject }}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ complaint.description[:100] }}...</p>
                                    <div class="mt-2 flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                                        <span>From: {{ complaint.from_name }}</span>
                                        <span>|</span>
                                        <span>{{ complaint.date }}</span>
                                        {% if complaint.related_contract %}
                                        <span>|</span>
                                        <a href="/contract/{{ complaint.related_contract.id }}" class="text-blue-600">{{ complaint.related_contract.title }}</a>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex flex-col items-end space-y-2">
                                    <span class="px-2 py-1 text-xs rounded-full
                                        {% if complaint.status == 'New' %}bg-blue-100 text-blue-800
                                        {% elif complaint.status == 'Investigating' %}bg-yellow-100 text-yellow-800
                                        {% elif complaint.status == 'Resolved' %}bg-green-100 text-green-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ complaint.status }}
                                    </span>
                                    <button class="text-sm text-blue-600 hover:text-blue-800">View Details</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Complaints by Category</h3>
                    <div class="space-y-3">
                        {% for cat in complaint_categories %}
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600 dark:text-gray-400">{{ cat.name }}</span>
                                <span class="font-medium text-gray-900 dark:text-white">{{ cat.count }}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: {{ cat.percentage }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Resolution Metrics</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Avg. Resolution Time</span>
                            <span class="text-lg font-bold text-gray-900 dark:text-white">{{ complaint_metrics.avg_resolution }} days</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">First Response Time</span>
                            <span class="text-lg font-bold text-green-600">{{ complaint_metrics.first_response }} hrs</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Satisfaction After Resolution</span>
                            <span class="text-lg font-bold text-blue-600">{{ "%.0f"|format(complaint_metrics.satisfaction) }}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Dashboard Tab -->
    <div id="content-feedback" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Community Engagement Trend</h3>
                <div id="engagementChart" class="h-64"></div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Satisfaction by Service Area</h3>
                <div class="space-y-4">
                    {% for area in satisfaction_by_area %}
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-700 dark:text-gray-300">{{ area.name }}</span>
                            <span class="font-medium {% if area.rating >= 4 %}text-green-600{% elif area.rating >= 3 %}text-yellow-600{% else %}text-red-600{% endif %}">{{ "%.1f"|format(area.rating) }}/5</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                            <div class="h-3 rounded-full {% if area.rating >= 4 %}bg-green-500{% elif area.rating >= 3 %}bg-yellow-500{% else %}bg-red-500{% endif %}" style="width: {{ area.rating * 20 }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Recent Feedback</h3>
                <div class="space-y-4">
                    {% for feedback in recent_feedback %}
                    <div class="border-l-4 pl-4 {% if feedback.rating >= 4 %}border-l-green-500{% elif feedback.rating >= 3 %}border-l-yellow-500{% else %}border-l-red-500{% endif %}">
                        <div class="flex items-center space-x-2 mb-1">
                            <div class="flex">
                                {% for i in range(5) %}
                                <svg class="w-4 h-4 {% if i < feedback.rating %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                </svg>
                                {% endfor %}
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">{{ feedback.date }}</span>
                        </div>
                        <p class="text-sm text-gray-700 dark:text-gray-300">{{ feedback.comment }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Service: {{ feedback.service }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Response Time Performance</h3>
                <div id="responseTimeChart" class="h-64"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            el.classList.add('text-gray-500');
        });
        document.getElementById('content-' + tabName).classList.remove('hidden');
        const activeTab = document.getElementById('tab-' + tabName);
        activeTab.classList.add('border-b-2', 'border-blue-500', 'text-blue-600', 'dark:text-blue-400');
        activeTab.classList.remove('text-gray-500');

        if (tabName === 'comments') {
            initSentimentChart();
        }
        if (tabName === 'feedback') {
            initFeedbackCharts();
        }
    }

    function initSentimentChart() {
        Plotly.newPlot('sentimentChart', [{
            values: [{{ sentiment_stats.support }}, {{ sentiment_stats.neutral }}, {{ sentiment_stats.oppose }}],
            labels: ['Support', 'Neutral', 'Oppose'],
            type: 'pie',
            hole: 0.5,
            marker: { colors: ['#10B981', '#6B7280', '#EF4444'] }
        }], {
            margin: { t: 10, b: 10, l: 10, r: 10 },
            paper_bgcolor: 'transparent',
            showlegend: false
        }, { responsive: true });
    }

    function initFeedbackCharts() {
        Plotly.newPlot('engagementChart', [{
            x: ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            y: [45, 52, 48, 61, 55, 68],
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Comments',
            line: { color: '#3B82F6' }
        }, {
            x: ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            y: [12, 15, 18, 14, 20, 17],
            type: 'scatter',
            mode: 'lines+markers',
            name: 'FOIA Requests',
            line: { color: '#10B981' }
        }], {
            margin: { t: 20, b: 40, l: 40, r: 20 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            legend: { orientation: 'h', y: 1.1 }
        }, { responsive: true });

        Plotly.newPlot('responseTimeChart', [{
            x: ['FOIA', 'Comments', 'Complaints', 'General'],
            y: [4.2, 1.5, 2.8, 1.2],
            type: 'bar',
            marker: {
                color: ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6']
            }
        }], {
            margin: { t: 20, b: 40, l: 50, r: 20 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            yaxis: { title: 'Avg. Days', gridcolor: '#e5e7eb' }
        }, { responsive: true });
    }

    // Initialize sentiment chart on page load
    document.addEventListener('DOMContentLoaded', function() {
        initSentimentChart();
    });
</script>
{% endblock %}

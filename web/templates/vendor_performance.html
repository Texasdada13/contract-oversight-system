{% extends "base.html" %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Vendor Performance Dashboard</h1>
        <p class="text-gray-500 dark:text-gray-400">Comprehensive vendor performance metrics and rankings</p>
    </div>
    <div class="flex space-x-3">
        <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            Export Report
        </button>
    </div>
</div>

<!-- Summary Stats -->
<div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow p-4 text-white">
        <p class="text-blue-100 text-xs">Total Vendors</p>
        <p class="text-2xl font-bold">{{ summary.total_vendors }}</p>
    </div>
    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow p-4 text-white">
        <p class="text-green-100 text-xs">Avg Performance</p>
        <p class="text-2xl font-bold">{{ summary.avg_performance|int }}</p>
    </div>
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow p-4 text-white">
        <p class="text-purple-100 text-xs">Top Performers</p>
        <p class="text-2xl font-bold">{{ summary.top_performers }}</p>
    </div>
    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow p-4 text-white">
        <p class="text-red-100 text-xs">Underperformers</p>
        <p class="text-2xl font-bold">{{ summary.underperformers }}</p>
    </div>
    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow p-4 text-white">
        <p class="text-orange-100 text-xs">Expired Insurance</p>
        <p class="text-2xl font-bold">{{ summary.expired_insurance }}</p>
    </div>
    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow p-4 text-white">
        <p class="text-yellow-100 text-xs">Expired License</p>
        <p class="text-2xl font-bold">{{ summary.expired_license }}</p>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Performance Distribution -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Performance Distribution</h3>
        <div id="performanceChart" style="height: 250px;"></div>
    </div>

    <!-- Top Performers -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Top 5 Vendors</h3>
        <div class="space-y-3">
            {% for vendor in vendors[:5] %}
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex items-center space-x-3">
                    <span class="text-xl font-bold
                        {% if loop.index == 1 %}text-yellow-500
                        {% elif loop.index == 2 %}text-gray-400
                        {% elif loop.index == 3 %}text-orange-400
                        {% else %}text-gray-600{% endif %}">
                        #{{ loop.index }}
                    </span>
                    <div>
                        <a href="{{ url_for('vendor_detail', vendor_id=vendor.vendor_id) }}" class="font-medium text-gray-800 dark:text-white hover:text-blue-600">
                            {{ vendor.name }}
                        </a>
                        <p class="text-xs text-gray-500">{{ vendor.contract_count }} contracts</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-2xl font-bold
                        {% if vendor.performance_score >= 80 %}text-green-600
                        {% elif vendor.performance_score >= 60 %}text-yellow-600
                        {% else %}text-red-600{% endif %}">
                        {{ vendor.performance_score|int }}
                    </span>
                    <p class="text-xs text-gray-500">score</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Vendor Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
    <div class="px-6 py-4 border-b dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">All Vendors</h3>
        <div class="flex space-x-2">
            <input type="text" id="vendorSearch" placeholder="Search vendors..." onkeyup="filterVendors()"
                class="px-3 py-2 border rounded-lg text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <select id="performanceFilter" onchange="filterVendors()"
                class="px-3 py-2 border rounded-lg text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">All Performance</option>
                <option value="excellent">Excellent (80+)</option>
                <option value="good">Good (60-79)</option>
                <option value="fair">Fair (40-59)</option>
                <option value="poor">Poor (&lt;40)</option>
            </select>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700" id="vendorTable">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase cursor-pointer" onclick="sortTable(0)">Rank</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase cursor-pointer" onclick="sortTable(1)">Vendor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase cursor-pointer" onclick="sortTable(2)">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase cursor-pointer" onclick="sortTable(3)">Contracts</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase cursor-pointer" onclick="sortTable(4)">Total Value</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Performance</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">On-Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">On-Budget</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Compliance</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for vendor in vendors %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 vendor-row"
                    data-name="{{ vendor.name|lower }}"
                    data-score="{{ vendor.performance_score }}">
                    <td class="px-6 py-4 text-sm font-medium text-gray-800 dark:text-white">
                        <span class="
                            {% if loop.index <= 3 %}text-lg font-bold
                            {% if loop.index == 1 %}text-yellow-500
                            {% elif loop.index == 2 %}text-gray-400
                            {% else %}text-orange-400{% endif %}
                            {% else %}text-gray-500{% endif %}">
                            {{ loop.index }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <a href="{{ url_for('vendor_detail', vendor_id=vendor.vendor_id) }}" class="text-blue-600 hover:underline font-medium">
                            {{ vendor.name }}
                        </a>
                        <div class="flex space-x-2 mt-1">
                            {% if vendor.insurance_status == 'Expired' %}
                            <span class="px-1.5 py-0.5 text-xs bg-red-100 text-red-800 rounded">Insurance Expired</span>
                            {% endif %}
                            {% if vendor.license_status == 'Expired' %}
                            <span class="px-1.5 py-0.5 text-xs bg-red-100 text-red-800 rounded">License Expired</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">{{ vendor.category }}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">
                        {{ vendor.contract_count }}
                        <span class="text-xs text-gray-400">({{ vendor.active_contracts }} active)</span>
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-800 dark:text-white">${{ '{:,.0f}'.format(vendor.total_value) }}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <span class="text-lg font-bold mr-2
                                {% if vendor.performance_score >= 80 %}text-green-600
                                {% elif vendor.performance_score >= 60 %}text-yellow-600
                                {% elif vendor.performance_score >= 40 %}text-orange-600
                                {% else %}text-red-600{% endif %}">
                                {{ vendor.performance_score|int }}
                            </span>
                            <div class="w-16 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                <div class="h-2 rounded-full
                                    {% if vendor.performance_score >= 80 %}bg-green-500
                                    {% elif vendor.performance_score >= 60 %}bg-yellow-500
                                    {% elif vendor.performance_score >= 40 %}bg-orange-500
                                    {% else %}bg-red-500{% endif %}"
                                    style="width: {{ vendor.performance_score }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded
                            {% if vendor.on_time_pct >= 80 %}bg-green-100 text-green-800
                            {% elif vendor.on_time_pct >= 60 %}bg-yellow-100 text-yellow-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ vendor.on_time_pct|int }}%
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded
                            {% if vendor.budget_adherence >= 80 %}bg-green-100 text-green-800
                            {% elif vendor.budget_adherence >= 60 %}bg-yellow-100 text-yellow-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ vendor.budget_adherence|int }}%
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        {% if vendor.insurance_status == 'Valid' and vendor.license_status == 'Valid' %}
                        <span class="px-2 py-1 text-xs font-medium rounded bg-green-100 text-green-800">Compliant</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-medium rounded bg-red-100 text-red-800">Issues</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Underperforming Vendors Alert -->
{% if summary.underperformers > 0 %}
<div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-6">
    <div class="flex items-start">
        <svg class="w-6 h-6 text-red-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <div>
            <h4 class="text-lg font-semibold text-red-800 dark:text-red-200">Attention Required</h4>
            <p class="text-red-600 dark:text-red-300 mt-1">
                {{ summary.underperformers }} vendor(s) have performance scores below 50.
                Consider reviewing their contracts and implementing performance improvement plans.
            </p>
            <div class="mt-3 flex flex-wrap gap-2">
                {% for vendor in vendors if vendor.performance_score < 50 %}
                <a href="{{ url_for('vendor_detail', vendor_id=vendor.vendor_id) }}"
                   class="px-3 py-1 bg-red-100 dark:bg-red-800 text-red-800 dark:text-red-100 rounded-lg text-sm hover:bg-red-200 dark:hover:bg-red-700">
                    {{ vendor.name }} ({{ vendor.performance_score|int }})
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Performance Distribution Chart
    const perfDist = {{ performance_dist | tojson | safe }};
    Plotly.newPlot('performanceChart', [{
        type: 'pie',
        labels: Object.keys(perfDist),
        values: Object.values(perfDist),
        hole: 0.4,
        marker: {
            colors: ['#22C55E', '#EAB308', '#F97316', '#EF4444']
        },
        textinfo: 'label+value'
    }], {
        margin: { t: 20, b: 20, l: 20, r: 20 },
        showlegend: false
    }, { responsive: true });

    // Filter vendors
    function filterVendors() {
        const searchTerm = document.getElementById('vendorSearch').value.toLowerCase();
        const performanceFilter = document.getElementById('performanceFilter').value;
        const rows = document.querySelectorAll('.vendor-row');

        rows.forEach(row => {
            const name = row.dataset.name;
            const score = parseFloat(row.dataset.score);

            let showBySearch = name.includes(searchTerm);
            let showByPerformance = true;

            if (performanceFilter === 'excellent') showByPerformance = score >= 80;
            else if (performanceFilter === 'good') showByPerformance = score >= 60 && score < 80;
            else if (performanceFilter === 'fair') showByPerformance = score >= 40 && score < 60;
            else if (performanceFilter === 'poor') showByPerformance = score < 40;

            row.style.display = (showBySearch && showByPerformance) ? '' : 'none';
        });
    }

    // Sort table
    let sortDirection = {};
    function sortTable(columnIndex) {
        const table = document.getElementById('vendorTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        sortDirection[columnIndex] = !sortDirection[columnIndex];
        const dir = sortDirection[columnIndex] ? 1 : -1;

        rows.sort((a, b) => {
            const aVal = a.cells[columnIndex].textContent.trim();
            const bVal = b.cells[columnIndex].textContent.trim();

            // Try numeric sort first
            const aNum = parseFloat(aVal.replace(/[,$%]/g, ''));
            const bNum = parseFloat(bVal.replace(/[,$%]/g, ''));

            if (!isNaN(aNum) && !isNaN(bNum)) {
                return (aNum - bNum) * dir;
            }

            return aVal.localeCompare(bVal) * dir;
        });

        rows.forEach(row => tbody.appendChild(row));
    }
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Spending Dashboard</h1>
        <p class="text-gray-500 dark:text-gray-400">Track payments, budgets, and spending trends</p>
    </div>
    <div class="flex space-x-3">
        <select id="fiscalYear" onchange="updateSpending()" class="px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            {% for year in fiscal_years %}
            <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>FY {{ year }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow p-6 text-white">
        <p class="text-blue-100 text-sm">Total Budget</p>
        <p class="text-3xl font-bold">${{ '{:,.0f}'.format(summary.total_budget) }}</p>
        <p class="text-blue-200 text-sm mt-2">{{ summary.total_contracts }} contracts</p>
    </div>
    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow p-6 text-white">
        <p class="text-green-100 text-sm">Total Spent</p>
        <p class="text-3xl font-bold">${{ '{:,.0f}'.format(summary.total_spent) }}</p>
        <p class="text-green-200 text-sm mt-2">{{ '{:.1f}'.format(summary.spent_pct) }}% of budget</p>
    </div>
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow p-6 text-white">
        <p class="text-purple-100 text-sm">Remaining</p>
        <p class="text-3xl font-bold">${{ '{:,.0f}'.format(summary.remaining) }}</p>
        <p class="text-purple-200 text-sm mt-2">{{ '{:.1f}'.format(100 - summary.spent_pct) }}% available</p>
    </div>
    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow p-6 text-white">
        <p class="text-orange-100 text-sm">Avg Monthly Spend</p>
        <p class="text-3xl font-bold">${{ '{:,.0f}'.format(summary.avg_monthly) }}</p>
        <p class="text-orange-200 text-sm mt-2">{{ summary.payment_count }} payments</p>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Monthly Spending Trend -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Monthly Spending Trend</h3>
        <div id="monthlyChart" style="height: 300px;"></div>
    </div>

    <!-- Spending by Department -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Spending by Department</h3>
        <div id="departmentChart" style="height: 300px;"></div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Budget vs Actual -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Budget vs Actual by Department</h3>
        <div id="budgetActualChart" style="height: 300px;"></div>
    </div>

    <!-- Top Vendors by Spending -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Top Vendors by Spending</h3>
        <div id="vendorChart" style="height: 300px;"></div>
    </div>
</div>

<!-- Department Breakdown -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
    <div class="px-6 py-4 border-b dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Department Spending Details</h3>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Department</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Budget</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Spent</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Remaining</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Utilization</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Contracts</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for dept in department_breakdown %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 font-medium text-gray-800 dark:text-white">{{ dept.name }}</td>
                    <td class="px-6 py-4 text-gray-600 dark:text-gray-300">${{ '{:,.0f}'.format(dept.budget) }}</td>
                    <td class="px-6 py-4 text-green-600 font-medium">${{ '{:,.0f}'.format(dept.spent) }}</td>
                    <td class="px-6 py-4 text-blue-600">${{ '{:,.0f}'.format(dept.remaining) }}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full
                                    {% if dept.utilization > 90 %}bg-red-500
                                    {% elif dept.utilization > 75 %}bg-yellow-500
                                    {% else %}bg-green-500{% endif %}"
                                    style="width: {{ dept.utilization }}%"></div>
                            </div>
                            <span class="text-sm {% if dept.utilization > 90 %}text-red-600{% elif dept.utilization > 75 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ '{:.1f}'.format(dept.utilization) }}%
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-600 dark:text-gray-300">{{ dept.contract_count }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <td class="px-6 py-4 font-bold text-gray-800 dark:text-white">Total</td>
                    <td class="px-6 py-4 font-bold text-gray-800 dark:text-white">${{ '{:,.0f}'.format(summary.total_budget) }}</td>
                    <td class="px-6 py-4 font-bold text-green-600">${{ '{:,.0f}'.format(summary.total_spent) }}</td>
                    <td class="px-6 py-4 font-bold text-blue-600">${{ '{:,.0f}'.format(summary.remaining) }}</td>
                    <td class="px-6 py-4 font-bold text-gray-800 dark:text-white">{{ '{:.1f}'.format(summary.spent_pct) }}%</td>
                    <td class="px-6 py-4 font-bold text-gray-800 dark:text-white">{{ summary.total_contracts }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- Recent Payments -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow">
    <div class="px-6 py-4 border-b dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Recent Payments</h3>
        <a href="#" class="text-sm text-blue-600 hover:underline">View All</a>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Contract</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Vendor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for payment in recent_payments %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">{{ payment.payment_date }}</td>
                    <td class="px-6 py-4">
                        <a href="{{ url_for('contract_detail', contract_id=payment.contract_id) }}" class="text-blue-600 hover:underline">
                            {{ payment.contract_title[:30] }}{% if payment.contract_title|length > 30 %}...{% endif %}
                        </a>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">{{ payment.vendor_name }}</td>
                    <td class="px-6 py-4 text-sm font-medium text-green-600">${{ '{:,.2f}'.format(payment.amount) }}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">{{ payment.payment_type or 'Standard' }}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded
                            {% if payment.status == 'Paid' %}bg-green-100 text-green-800
                            {% elif payment.status == 'Pending' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ payment.status }}
                        </span>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                        No recent payments
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Monthly Spending Chart
    const monthlyData = {{ monthly_spending | tojson | safe }};
    Plotly.newPlot('monthlyChart', [{
        type: 'bar',
        x: monthlyData.map(d => d.month),
        y: monthlyData.map(d => d.amount),
        marker: { color: '#3B82F6' }
    }, {
        type: 'scatter',
        mode: 'lines+markers',
        x: monthlyData.map(d => d.month),
        y: monthlyData.map(d => d.cumulative),
        yaxis: 'y2',
        name: 'Cumulative',
        line: { color: '#10B981', width: 2 }
    }], {
        margin: { t: 20, b: 40, l: 60, r: 60 },
        yaxis: { title: 'Monthly ($)', tickformat: ',.0f' },
        yaxis2: { title: 'Cumulative ($)', overlaying: 'y', side: 'right', tickformat: ',.0f' },
        showlegend: false
    }, { responsive: true });

    // Department Spending Chart
    const deptData = {{ department_spending | tojson | safe }};
    Plotly.newPlot('departmentChart', [{
        type: 'pie',
        labels: deptData.map(d => d.name),
        values: deptData.map(d => d.spent),
        hole: 0.4,
        marker: { colors: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'] }
    }], {
        margin: { t: 20, b: 20, l: 20, r: 20 },
        showlegend: true,
        legend: { orientation: 'h', y: -0.1 }
    }, { responsive: true });

    // Budget vs Actual Chart
    const budgetData = {{ department_breakdown | tojson | safe }};
    Plotly.newPlot('budgetActualChart', [{
        type: 'bar',
        name: 'Budget',
        x: budgetData.map(d => d.name),
        y: budgetData.map(d => d.budget),
        marker: { color: '#E5E7EB' }
    }, {
        type: 'bar',
        name: 'Spent',
        x: budgetData.map(d => d.name),
        y: budgetData.map(d => d.spent),
        marker: { color: '#3B82F6' }
    }], {
        margin: { t: 20, b: 60, l: 60, r: 20 },
        barmode: 'group',
        xaxis: { tickangle: -30 },
        yaxis: { tickformat: ',.0f' }
    }, { responsive: true });

    // Top Vendors Chart
    const vendorData = {{ top_vendors | tojson | safe }};
    Plotly.newPlot('vendorChart', [{
        type: 'bar',
        orientation: 'h',
        x: vendorData.map(d => d.spent),
        y: vendorData.map(d => d.name),
        marker: { color: '#10B981' }
    }], {
        margin: { t: 20, b: 40, l: 150, r: 20 },
        xaxis: { tickformat: ',.0f' }
    }, { responsive: true });

    function updateSpending() {
        const year = document.getElementById('fiscalYear').value;
        window.location.href = `/spending?year=${year}`;
    }
</script>
{% endblock %}

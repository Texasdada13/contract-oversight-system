{% extends "base.html" %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Analytics Dashboard</h1>
        <p class="text-gray-500 dark:text-gray-400">Advanced insights and performance metrics</p>
    </div>
    <div class="flex space-x-3">
        <button onclick="exportAnalytics()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            Export Report
        </button>
    </div>
</div>

<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow p-6 text-white">
        <p class="text-blue-100 text-sm">Total Portfolio Value</p>
        <p class="text-3xl font-bold">${{ '{:,.0f}'.format(summary.total_value) }}</p>
        <p class="text-blue-200 text-sm mt-2">{{ summary.total_contracts }} contracts</p>
    </div>
    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow p-6 text-white">
        <p class="text-green-100 text-sm">Amount Spent</p>
        <p class="text-3xl font-bold">${{ '{:,.0f}'.format(summary.total_paid) }}</p>
        <p class="text-green-200 text-sm mt-2">{{ '{:.1f}'.format(forecast.burn_rate_pct) }}% of budget</p>
    </div>
    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow p-6 text-white">
        <p class="text-orange-100 text-sm">Cost Overruns</p>
        <p class="text-3xl font-bold">${{ '{:,.0f}'.format(summary.total_overrun) }}</p>
        <p class="text-orange-200 text-sm mt-2">+{{ '{:.1f}'.format(summary.overrun_pct) }}% variance</p>
    </div>
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow p-6 text-white">
        <p class="text-purple-100 text-sm">Avg Health Score</p>
        <p class="text-3xl font-bold">{{ summary.avg_health_score|int }}</p>
        <p class="text-purple-200 text-sm mt-2">{{ summary.at_risk_count }} at risk</p>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Monthly Spending Trend -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Monthly Spending Trend</h3>
        <div id="trendChart" style="height: 300px;"></div>
    </div>

    <!-- Risk Distribution -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Risk Distribution</h3>
        <div id="riskChart" style="height: 300px;"></div>
    </div>
</div>

<!-- Department Analysis -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
    <div class="px-6 py-4 border-b dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Department Analysis</h3>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Department</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Contracts</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Total Value</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Overrun</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Avg Health</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">At Risk</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for dept in dept_analysis %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 font-medium text-gray-800 dark:text-white">{{ dept.department }}</td>
                    <td class="px-6 py-4 text-gray-600 dark:text-gray-300">{{ dept.contract_count }}</td>
                    <td class="px-6 py-4 text-gray-800 dark:text-white font-medium">${{ '{:,.0f}'.format(dept.total_value) }}</td>
                    <td class="px-6 py-4 {% if dept.overrun_amount > 0 %}text-red-600{% else %}text-green-600{% endif %} font-medium">
                        {% if dept.overrun_amount > 0 %}+{% endif %}${{ '{:,.0f}'.format(dept.overrun_amount) }}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-16 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full
                                    {% if dept.avg_health < 50 %}bg-red-500
                                    {% elif dept.avg_health < 70 %}bg-yellow-500
                                    {% else %}bg-green-500{% endif %}"
                                    style="width: {{ dept.avg_health }}%"></div>
                            </div>
                            <span class="text-sm">{{ dept.avg_health|int }}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded
                            {% if dept.at_risk_count > 0 %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                            {{ dept.at_risk_count }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Contract Type Analysis -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Contract Type Performance</h3>
        <div id="typeChart" style="height: 300px;"></div>
    </div>

    <!-- Budget Forecast -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Budget Forecast</h3>
        <div class="space-y-4">
            <div>
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600 dark:text-gray-400">Budget Utilization</span>
                    <span class="font-medium text-gray-800 dark:text-white">{{ '{:.1f}'.format(forecast.burn_rate_pct) }}%</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                    <div class="bg-blue-600 h-4 rounded-full" style="width: {{ forecast.burn_rate_pct }}%"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-4">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Budget</p>
                    <p class="text-xl font-bold text-gray-800 dark:text-white">${{ '{:,.0f}'.format(forecast.total_budget) }}</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Spent to Date</p>
                    <p class="text-xl font-bold text-green-600">${{ '{:,.0f}'.format(forecast.spent_to_date) }}</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Remaining</p>
                    <p class="text-xl font-bold text-blue-600">${{ '{:,.0f}'.format(forecast.remaining) }}</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Avg Monthly Burn</p>
                    <p class="text-xl font-bold text-orange-600">${{ '{:,.0f}'.format(forecast.avg_monthly_burn) }}</p>
                </div>
            </div>

            <div class="pt-4 border-t dark:border-gray-700">
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    At current burn rate, remaining budget covers approximately
                    <span class="font-bold text-gray-800 dark:text-white">{{ '{:.1f}'.format(forecast.projected_completion_months) }} months</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Vendor Rankings -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
    <div class="px-6 py-4 border-b dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Top Vendor Performance</h3>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            {% for vendor in vendor_rankings %}
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 {% if loop.index <= 3 %}border-2 {% if loop.index == 1 %}border-yellow-400{% elif loop.index == 2 %}border-gray-400{% else %}border-orange-400{% endif %}{% endif %}">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-2xl font-bold
                        {% if loop.index == 1 %}text-yellow-500
                        {% elif loop.index == 2 %}text-gray-400
                        {% elif loop.index == 3 %}text-orange-400
                        {% else %}text-gray-600{% endif %}">
                        #{{ loop.index }}
                    </span>
                    <span class="text-2xl font-bold
                        {% if vendor.performance_score >= 70 %}text-green-600
                        {% elif vendor.performance_score >= 50 %}text-yellow-600
                        {% else %}text-red-600{% endif %}">
                        {{ vendor.performance_score|int }}
                    </span>
                </div>
                <a href="{{ url_for('vendor_detail', vendor_id=vendor.vendor_id) }}" class="font-medium text-gray-800 dark:text-white hover:text-blue-600">
                    {{ vendor.name[:20] }}{% if vendor.name|length > 20 %}...{% endif %}
                </a>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    {{ vendor.contract_count }} contracts | ${{ '{:,.0f}'.format(vendor.total_value) }}
                </p>
                <div class="mt-2 flex space-x-2 text-xs">
                    <span class="text-green-600">{{ vendor.on_time_pct|int }}% on-time</span>
                    <span class="text-blue-600">{{ vendor.budget_adherence|int }}% on-budget</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Contract Type Stats -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow">
    <div class="px-6 py-4 border-b dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Contract Type Analysis</h3>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {% for ctype in type_analysis %}
            <div class="border dark:border-gray-700 rounded-lg p-4">
                <h4 class="font-medium text-gray-800 dark:text-white mb-2">{{ ctype.type }}</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-500">Count</span>
                        <span class="font-medium text-gray-800 dark:text-white">{{ ctype.count }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Total Value</span>
                        <span class="font-medium text-gray-800 dark:text-white">${{ '{:,.0f}'.format(ctype.total_value) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Avg Overrun</span>
                        <span class="font-medium {% if ctype.avg_overrun > 10 %}text-red-600{% elif ctype.avg_overrun > 0 %}text-orange-600{% else %}text-green-600{% endif %}">
                            {% if ctype.avg_overrun > 0 %}+{% endif %}{{ '{:.1f}'.format(ctype.avg_overrun) }}%
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Monthly Spending Trend
    const monthlyData = {{ monthly_data | tojson | safe }};
    Plotly.newPlot('trendChart', [{
        type: 'scatter',
        mode: 'lines+markers',
        x: monthlyData.map(d => d.month),
        y: monthlyData.map(d => d.spending),
        line: { color: '#3B82F6', width: 3 },
        marker: { size: 8 },
        fill: 'tozeroy',
        fillcolor: 'rgba(59, 130, 246, 0.1)'
    }], {
        margin: { t: 20, b: 40, l: 60, r: 20 },
        xaxis: { tickangle: -45 },
        yaxis: { title: 'Spending ($)', tickformat: ',.0f' }
    }, { responsive: true });

    // Risk Distribution
    const riskData = {{ risk_distribution | tojson | safe }};
    Plotly.newPlot('riskChart', [{
        type: 'pie',
        labels: Object.keys(riskData),
        values: Object.values(riskData),
        hole: 0.5,
        marker: {
            colors: ['#EF4444', '#F97316', '#EAB308', '#22C55E']
        },
        textinfo: 'label+value'
    }], {
        margin: { t: 20, b: 20, l: 20, r: 20 },
        showlegend: false
    }, { responsive: true });

    // Contract Type Chart
    const typeData = {{ type_analysis | tojson | safe }};
    Plotly.newPlot('typeChart', [{
        type: 'bar',
        x: typeData.map(d => d.type),
        y: typeData.map(d => d.total_value),
        marker: {
            color: typeData.map(d => d.avg_overrun > 10 ? '#EF4444' : d.avg_overrun > 0 ? '#F97316' : '#22C55E')
        },
        text: typeData.map(d => `${d.count} contracts`),
        textposition: 'outside'
    }], {
        margin: { t: 20, b: 60, l: 60, r: 20 },
        xaxis: { tickangle: -30 },
        yaxis: { title: 'Total Value ($)', tickformat: ',.0f' }
    }, { responsive: true });

    function exportAnalytics() {
        window.print();
    }
</script>
{% endblock %}

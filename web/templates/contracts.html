{% extends "base.html" %}

{% block content %}
<!-- Page Header -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Contract Management</h1>
        <p class="text-gray-500 dark:text-gray-400">Monitor and manage all government contracts</p>
    </div>
    <div class="mt-4 md:mt-0 flex space-x-3">
        <button onclick="openAddContractModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            New Contract
        </button>
        <button onclick="exportContracts()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export
        </button>
    </div>
</div>

<!-- Saved Searches -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-4 p-4">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Saved Searches:</span>
            <div id="savedSearchesList" class="flex flex-wrap gap-2">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        <button onclick="saveCurrentSearch()" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Save Current Search
        </button>
    </div>
</div>

<!-- Filters -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6 p-4">
    <form method="GET" class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Search</label>
            <input type="text" name="search" id="searchInput" value="{{ request.args.get('search', '') }}"
                   placeholder="Contract title or number..."
                   class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
            <select name="status" id="statusFilter" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">All Statuses</option>
                <option value="Active" {% if request.args.get('status') == 'Active' %}selected{% endif %}>Active</option>
                <option value="Completed" {% if request.args.get('status') == 'Completed' %}selected{% endif %}>Completed</option>
                <option value="Draft" {% if request.args.get('status') == 'Draft' %}selected{% endif %}>Draft</option>
                <option value="Cancelled" {% if request.args.get('status') == 'Cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Department</label>
            <select name="department" id="deptFilter" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">All Departments</option>
                {% for dept in departments %}
                <option value="{{ dept }}" {% if request.args.get('department') == dept %}selected{% endif %}>{{ dept }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 flex items-center gap-1.5">
                Health
                <span class="relative">
                    <button type="button" onclick="toggleHealthLegend(event, 'healthLegendFilter')" class="health-info-btn" aria-label="Health score information">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div id="healthLegendFilter" class="health-legend"></div>
                </span>
            </label>
            <select name="health" id="healthFilter" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">All Health Scores</option>
                <option value="critical" {% if request.args.get('health') == 'critical' %}selected{% endif %}>Critical (&lt;30)</option>
                <option value="at_risk" {% if request.args.get('health') == 'at_risk' %}selected{% endif %}>At Risk (30-50)</option>
                <option value="warning" {% if request.args.get('health') == 'warning' %}selected{% endif %}>Warning (50-70)</option>
                <option value="healthy" {% if request.args.get('health') == 'healthy' %}selected{% endif %}>Healthy (&gt;70)</option>
            </select>
        </div>
        <div class="flex items-end space-x-2">
            <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Apply
            </button>
            <a href="{{ url_for('contracts_list') }}" class="px-4 py-2 border rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                Clear
            </a>
        </div>
        <div class="flex items-end">
            <select id="sortBy" onchange="applySorting()" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">Sort By...</option>
                <option value="title_asc">Title (A-Z)</option>
                <option value="title_desc">Title (Z-A)</option>
                <option value="value_desc">Value (High-Low)</option>
                <option value="value_asc">Value (Low-High)</option>
                <option value="health_asc">Health (Low-High)</option>
                <option value="health_desc">Health (High-Low)</option>
                <option value="date_asc">End Date (Earliest)</option>
                <option value="date_desc">End Date (Latest)</option>
            </select>
        </div>
    </form>
</div>

<!-- Summary Stats -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
        <p class="text-2xl font-bold text-blue-600">{{ contracts|length }}</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">Total Shown</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
        <p class="text-2xl font-bold text-green-600">${{ '{:,.0f}'.format(total_value) }}</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">Total Value</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
        <p class="text-2xl font-bold text-red-600">{{ at_risk_count }}</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">At Risk</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 text-center">
        <p class="text-2xl font-bold text-orange-600">{{ overrun_count }}</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">Over Budget</p>
    </div>
</div>

<!-- Bulk Actions Bar (hidden until contracts selected) -->
<div id="bulkActionsBar" class="hidden bg-blue-600 text-white rounded-lg shadow mb-4 p-4">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <span id="selectedCount">0 contracts selected</span>
            <button onclick="clearSelection()" class="text-blue-200 hover:text-white underline text-sm">Clear</button>
        </div>
        <div class="flex space-x-3">
            <button onclick="compareSelected()" class="px-4 py-2 bg-white text-blue-600 rounded-lg hover:bg-blue-50 font-medium">
                Compare
            </button>
            <button onclick="bulkUpdateStatus()" class="px-4 py-2 bg-white text-blue-600 rounded-lg hover:bg-blue-50 font-medium">
                Update Status
            </button>
            <button onclick="bulkExport()" class="px-4 py-2 bg-white text-blue-600 rounded-lg hover:bg-blue-50 font-medium">
                Export
            </button>
            <button onclick="bulkAssignDepartment()" class="px-4 py-2 bg-white text-blue-600 rounded-lg hover:bg-blue-50 font-medium">
                Assign Dept
            </button>
        </div>
    </div>
</div>

<!-- Bulk Status Update Modal -->
<div id="bulkStatusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="bulkStatusModal-title">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
        <h3 id="bulkStatusModal-title" class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Update Contract Status</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Update status for <span id="bulkStatusCount">0</span> selected contracts</p>
        <select id="bulkStatusSelect" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white mb-4">
            <option value="">Select New Status</option>
            <option value="Active">Active</option>
            <option value="Completed">Completed</option>
            <option value="Draft">Draft</option>
            <option value="Cancelled">Cancelled</option>
            <option value="On Hold">On Hold</option>
        </select>
        <div class="flex justify-end space-x-3">
            <button onclick="closeBulkStatusModal()" class="px-4 py-2 border rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                Cancel
            </button>
            <button onclick="applyBulkStatus()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Apply
            </button>
        </div>
    </div>
</div>

<!-- Bulk Department Assign Modal -->
<div id="bulkDeptModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="bulkDeptModal-title">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
        <h3 id="bulkDeptModal-title" class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Assign Department</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Assign department for <span id="bulkDeptCount">0</span> selected contracts</p>
        <select id="bulkDeptSelect" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white mb-4">
            <option value="">Select Department</option>
            {% for dept in departments %}
            <option value="{{ dept }}">{{ dept }}</option>
            {% endfor %}
        </select>
        <div class="flex justify-end space-x-3">
            <button onclick="closeBulkDeptModal()" class="px-4 py-2 border rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                Cancel
            </button>
            <button onclick="applyBulkDept()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Apply
            </button>
        </div>
    </div>
</div>

<!-- View Toggle (visible on mobile) -->
<div class="flex justify-end mb-4 md:hidden">
    <div class="inline-flex rounded-lg border dark:border-gray-600 p-1 bg-white dark:bg-gray-800">
        <button id="tableViewBtn" onclick="setContractView('table')" class="px-3 py-1.5 text-sm rounded-md transition-colors bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200" aria-pressed="true">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
        </button>
        <button id="cardViewBtn" onclick="setContractView('card')" class="px-3 py-1.5 text-sm rounded-md transition-colors text-gray-600 dark:text-gray-400" aria-pressed="false">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
            </svg>
        </button>
    </div>
</div>

<!-- Mobile Card View -->
<div id="contractCardsView" class="hidden space-y-4 md:hidden">
    {% for contract in contracts %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="window.location='{{ url_for('contract_detail', contract_id=contract.contract_id) }}'">
        <div class="flex justify-between items-start mb-3">
            <div class="flex-1 min-w-0">
                <h3 class="font-medium text-gray-800 dark:text-white truncate">{{ contract.title }}</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ contract.contract_number }}</p>
            </div>
            <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full shrink-0
                {% if contract.status == 'Active' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                {% elif contract.status == 'Completed' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                {% elif contract.status == 'Draft' %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200
                {% else %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% endif %}">
                {{ contract.status }}
            </span>
        </div>
        <div class="grid grid-cols-2 gap-3 text-sm">
            <div>
                <p class="text-xs text-gray-500 dark:text-gray-400">Vendor</p>
                <p class="text-gray-800 dark:text-white truncate">{{ contract.vendor_name }}</p>
            </div>
            <div>
                <p class="text-xs text-gray-500 dark:text-gray-400">Value</p>
                <p class="font-medium text-gray-800 dark:text-white">${{ '{:,.0f}'.format(contract.current_amount or contract.original_amount) }}</p>
            </div>
            <div>
                <p class="text-xs text-gray-500 dark:text-gray-400">Department</p>
                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">{{ contract.department }}</span>
            </div>
            <div>
                <p class="text-xs text-gray-500 dark:text-gray-400">End Date</p>
                <p class="text-gray-800 dark:text-white">{{ contract.end_date|format_date }}</p>
                {% if contract.days_remaining is defined and contract.days_remaining < 30 %}
                <p class="text-xs text-red-600">{{ contract.days_remaining }} days left</p>
                {% endif %}
            </div>
        </div>
        <div class="mt-3 pt-3 border-t dark:border-gray-700 flex justify-between items-center">
            {% set health = contract.overall_health_score|int if contract.overall_health_score else 100 %}
            <div class="flex items-center">
                <span class="text-xs text-gray-500 dark:text-gray-400 mr-2">Health:</span>
                <div class="w-20 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                    <div class="h-2 rounded-full
                        {% if health < 30 %}bg-red-600
                        {% elif health < 50 %}bg-orange-500
                        {% elif health < 70 %}bg-yellow-500
                        {% else %}bg-green-500{% endif %}"
                        style="width: {{ health }}%"></div>
                </div>
                <span class="text-sm font-medium
                    {% if health < 30 %}text-red-600
                    {% elif health < 50 %}text-orange-600
                    {% elif health < 70 %}text-yellow-600
                    {% else %}text-green-600{% endif %}">{{ health }}</span>
            </div>
            <a href="{{ url_for('contract_detail', contract_id=contract.contract_id) }}" class="text-blue-600 dark:text-blue-400 text-sm font-medium" onclick="event.stopPropagation()">
                View Details â†’
            </a>
        </div>
    </div>
    {% else %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center">
        <p class="text-gray-500 dark:text-gray-400">No contracts found</p>
    </div>
    {% endfor %}
</div>

<!-- Contracts Table (hidden on mobile when card view is active) -->
<div id="contractTableView" class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="rounded">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Contract</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Vendor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Department</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Value</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Health</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">End Date</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {% for contract in contracts %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-4" onclick="event.stopPropagation()">
                        <input type="checkbox" class="contract-checkbox rounded" data-contract-id="{{ contract.contract_id }}" onchange="updateSelection()">
                    </td>
                    <td class="px-6 py-4 cursor-pointer" onclick="window.location='{{ url_for('contract_detail', contract_id=contract.contract_id) }}'">
                        <div class="flex items-center">
                            <div class="max-w-xs">
                                <p class="font-medium text-gray-800 dark:text-white truncate-tooltip" {% if contract.title|length > 40 %}data-tooltip="{{ contract.title }}"{% endif %}>{{ contract.title[:40] }}{% if contract.title|length > 40 %}...{% endif %}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ contract.contract_number }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <p class="text-sm text-gray-800 dark:text-white truncate-tooltip max-w-[150px]" {% if contract.vendor_name|length > 20 %}data-tooltip="{{ contract.vendor_name }}"{% endif %}>{{ contract.vendor_name }}</p>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                            {{ contract.department }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <p class="text-sm font-medium text-gray-800 dark:text-white">${{ '{:,.0f}'.format(contract.current_amount or contract.original_amount) }}</p>
                        {% if contract.current_amount and contract.current_amount > contract.original_amount %}
                        <p class="text-xs text-red-600">
                            +${{ '{:,.0f}'.format(contract.current_amount - contract.original_amount) }}
                            <span class="text-red-500">({{ '{:.1f}'.format(((contract.current_amount - contract.original_amount) / contract.original_amount) * 100) }}%)</span>
                        </p>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full
                            {% if contract.status == 'Active' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                            {% elif contract.status == 'Completed' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                            {% elif contract.status == 'Draft' %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200
                            {% else %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% endif %}">
                            {{ contract.status }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        {% set health = contract.overall_health_score|int if contract.overall_health_score else 100 %}
                        <div class="flex items-center">
                            <div class="w-16 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full
                                    {% if health < 30 %}bg-red-600
                                    {% elif health < 50 %}bg-orange-500
                                    {% elif health < 70 %}bg-yellow-500
                                    {% else %}bg-green-500{% endif %}"
                                    style="width: {{ health }}%"></div>
                            </div>
                            <span class="text-sm font-medium
                                {% if health < 30 %}text-red-600
                                {% elif health < 50 %}text-orange-600
                                {% elif health < 70 %}text-yellow-600
                                {% else %}text-green-600{% endif %}">
                                {{ health }}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <p class="text-sm text-gray-800 dark:text-white">{{ contract.end_date|format_date }}</p>
                        {% if contract.days_remaining is defined %}
                        <p class="text-xs {% if contract.days_remaining < 30 %}text-red-600{% elif contract.days_remaining < 90 %}text-yellow-600{% else %}text-gray-500{% endif %}">
                            {% if contract.days_remaining < 0 %}{{ -contract.days_remaining }} days overdue
                            {% elif contract.days_remaining == 0 %}Ends today
                            {% else %}{{ contract.days_remaining }} days left{% endif %}
                        </p>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right" onclick="event.stopPropagation()">
                        <div class="flex justify-end space-x-2">
                            <a href="{{ url_for('contract_detail', contract_id=contract.contract_id) }}"
                               class="text-blue-600 hover:text-blue-800 dark:text-blue-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </a>
                            <button onclick="editContract('{{ contract.contract_id }}')"
                                    class="text-gray-600 hover:text-gray-800 dark:text-gray-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="empty-state-title">No contracts found</h3>
                            <p class="empty-state-description">
                                {% if request.args.get('search') or request.args.get('status') or request.args.get('department') %}
                                    Try adjusting your search filters or clear all filters to see all contracts.
                                {% else %}
                                    Get started by creating your first contract.
                                {% endif %}
                            </p>
                            <div class="flex justify-center space-x-3">
                                {% if request.args.get('search') or request.args.get('status') or request.args.get('department') %}
                                    <a href="{{ url_for('contracts_list') }}" class="btn btn-outline">Clear Filters</a>
                                {% endif %}
                                <button onclick="openAddContractModal()" class="btn btn-primary">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    New Contract
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if pagination and pagination.total_count > 0 %}
    <div class="px-6 py-4 border-t dark:border-gray-700 flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="text-sm text-gray-600 dark:text-gray-400">
            Showing <span class="font-medium">{{ pagination.start_idx }}</span> to <span class="font-medium">{{ pagination.end_idx }}</span> of <span class="font-medium">{{ pagination.total_count }}</span> contracts
        </div>
        <div class="flex items-center space-x-2">
            <!-- Per Page Selector -->
            <select onchange="changePerPage(this.value)" class="text-sm border rounded-lg px-2 py-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10 per page</option>
                <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25 per page</option>
                <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50 per page</option>
                <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100 per page</option>
            </select>

            <!-- Pagination Buttons -->
            <nav class="flex items-center space-x-1" aria-label="Pagination">
                <!-- Previous -->
                <a href="{{ url_for('contracts_list', page=pagination.page - 1, per_page=pagination.per_page, search=request.args.get('search', ''), status=request.args.get('status', ''), department=request.args.get('department', ''), health=request.args.get('health', '')) }}"
                   class="px-3 py-1.5 text-sm rounded-lg {% if pagination.has_prev %}text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% else %}text-gray-400 dark:text-gray-600 cursor-not-allowed pointer-events-none{% endif %}"
                   {% if not pagination.has_prev %}aria-disabled="true"{% endif %}>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>

                <!-- Page Numbers -->
                {% for p in pagination.pages %}
                <a href="{{ url_for('contracts_list', page=p, per_page=pagination.per_page, search=request.args.get('search', ''), status=request.args.get('status', ''), department=request.args.get('department', ''), health=request.args.get('health', '')) }}"
                   class="px-3 py-1.5 text-sm rounded-lg {% if p == pagination.page %}bg-blue-600 text-white{% else %}text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}">
                    {{ p }}
                </a>
                {% endfor %}

                <!-- Next -->
                <a href="{{ url_for('contracts_list', page=pagination.page + 1, per_page=pagination.per_page, search=request.args.get('search', ''), status=request.args.get('status', ''), department=request.args.get('department', ''), health=request.args.get('health', '')) }}"
                   class="px-3 py-1.5 text-sm rounded-lg {% if pagination.has_next %}text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700{% else %}text-gray-400 dark:text-gray-600 cursor-not-allowed pointer-events-none{% endif %}"
                   {% if not pagination.has_next %}aria-disabled="true"{% endif %}>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </a>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Contract Modal -->
<div id="addContractModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="addContractModal-title">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b dark:border-gray-700 flex justify-between items-center">
            <h3 id="addContractModal-title" class="text-lg font-semibold text-gray-800 dark:text-white">New Contract</h3>
            <button onclick="closeAddContractModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400" aria-label="Close modal">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form id="addContractForm" class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contract Number *</label>
                    <input type="text" name="contract_number" required
                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                           placeholder="e.g., CON-2024-001">
                </div>
                <div class="form-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vendor *</label>
                    <select name="vendor_id" required
                            class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Select Vendor</option>
                        {% for vendor in vendors %}
                        <option value="{{ vendor.vendor_id }}">{{ vendor.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-field">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title *</label>
                <input type="text" name="title" required
                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                       placeholder="Enter contract title">
            </div>
            <div class="form-field">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                <textarea name="description" rows="3"
                          class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                          placeholder="Brief description of the contract"></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Department *</label>
                    <select name="department" required
                            class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Select Department</option>
                        <option value="School Board">School Board</option>
                        <option value="City Council">City Council</option>
                        <option value="Public Works">Public Works</option>
                        <option value="Parks & Recreation">Parks & Recreation</option>
                        <option value="Administration">Administration</option>
                    </select>
                </div>
                <div class="form-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contract Type *</label>
                    <select name="contract_type" required
                            class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Select Type</option>
                        <option value="Fixed Price">Fixed Price</option>
                        <option value="Time & Materials">Time & Materials</option>
                        <option value="Cost Plus">Cost Plus</option>
                        <option value="Unit Price">Unit Price</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Original Amount *</label>
                    <input type="number" name="original_amount" required step="0.01" min="0"
                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                           placeholder="0.00">
                </div>
                <div class="form-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Funded Amount</label>
                    <input type="number" name="funded_amount" step="0.01" min="0"
                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                           placeholder="0.00">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Date *</label>
                    <input type="date" name="start_date" id="contract_start_date" required
                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="form-field">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Date *</label>
                    <input type="date" name="end_date" id="contract_end_date" required
                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeAddContractModal()"
                        class="px-4 py-2 border rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Create Contract
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ====== Mobile View Toggle ======
    function setContractView(view) {
        const tableView = document.getElementById('contractTableView');
        const cardView = document.getElementById('contractCardsView');
        const tableBtn = document.getElementById('tableViewBtn');
        const cardBtn = document.getElementById('cardViewBtn');

        if (view === 'card') {
            tableView.classList.add('hidden');
            cardView.classList.remove('hidden');
            tableBtn.classList.remove('bg-blue-100', 'text-blue-700', 'dark:bg-blue-900', 'dark:text-blue-200');
            tableBtn.classList.add('text-gray-600', 'dark:text-gray-400');
            cardBtn.classList.add('bg-blue-100', 'text-blue-700', 'dark:bg-blue-900', 'dark:text-blue-200');
            cardBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
            tableBtn.setAttribute('aria-pressed', 'false');
            cardBtn.setAttribute('aria-pressed', 'true');
            setPagePreference('contracts', 'mobileView', 'card');
        } else {
            tableView.classList.remove('hidden');
            cardView.classList.add('hidden');
            cardBtn.classList.remove('bg-blue-100', 'text-blue-700', 'dark:bg-blue-900', 'dark:text-blue-200');
            cardBtn.classList.add('text-gray-600', 'dark:text-gray-400');
            tableBtn.classList.add('bg-blue-100', 'text-blue-700', 'dark:bg-blue-900', 'dark:text-blue-200');
            tableBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
            cardBtn.setAttribute('aria-pressed', 'false');
            tableBtn.setAttribute('aria-pressed', 'true');
            setPagePreference('contracts', 'mobileView', 'table');
        }
    }

    function loadMobileViewPreference() {
        const savedView = getPagePreference('contracts', 'mobileView', 'table');
        if (savedView === 'card' && window.innerWidth < 768) {
            setContractView('card');
        }
    }

    // ====== Modal Functions ======
    let addContractTrigger = null;

    function openAddContractModal() {
        addContractTrigger = document.activeElement;
        openAccessibleModal('addContractModal', addContractTrigger);
    }

    function closeAddContractModal() {
        closeAccessibleModal('addContractModal');
    }

    // Setup backdrop click close for addContractModal
    document.addEventListener('DOMContentLoaded', function() {
        setupModalBackdropClose('addContractModal', closeAddContractModal);

        // Initialize form validation for add contract form
        initFormValidation('addContractForm', {
            contract_number: { minLength: 3 },
            title: { minLength: 5 },
            original_amount: { positiveNumber: true },
            funded_amount: { positiveNumber: true }
        });

        // Custom validation for end date > start date
        const endDateField = document.getElementById('contract_end_date');
        const startDateField = document.getElementById('contract_start_date');

        if (endDateField && startDateField) {
            endDateField.addEventListener('blur', function() {
                if (startDateField.value && this.value) {
                    if (new Date(this.value) <= new Date(startDateField.value)) {
                        const container = this.closest('.form-field');
                        container.classList.remove('is-valid');
                        container.classList.add('is-invalid');
                        let errorEl = container.querySelector('.error-message');
                        if (!errorEl) {
                            errorEl = document.createElement('span');
                            errorEl.className = 'error-message';
                            container.appendChild(errorEl);
                        }
                        errorEl.textContent = 'End date must be after start date';
                    }
                }
            });

            startDateField.addEventListener('change', function() {
                // Re-validate end date when start date changes
                if (endDateField.dataset.touched === 'true') {
                    endDateField.dispatchEvent(new Event('blur'));
                }
            });
        }
    });

    document.getElementById('addContractForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        data.contract_id = 'CNT-' + Date.now();

        const submitBtn = this.querySelector('button[type="submit"]');
        setButtonLoading(submitBtn, true);

        try {
            const response = await fetch('/api/contract', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showSuccess('Contract created successfully!');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                const error = await response.json();
                showError(error.error || 'Failed to create contract');
                setButtonLoading(submitBtn, false);
            }
        } catch (err) {
            showError('Error creating contract: ' + err.message);
            setButtonLoading(submitBtn, false);
        }
    });

    function editContract(contractId) {
        window.location.href = `/contract/${contractId}?edit=true`;
    }

    function exportContracts() {
        window.location.href = '/api/export?' + window.location.search.substring(1);
    }

    // ====== Selection Management ======
    let selectedContracts = new Set();

    function updateSelection() {
        selectedContracts.clear();
        document.querySelectorAll('.contract-checkbox:checked').forEach(cb => {
            selectedContracts.add(cb.dataset.contractId);
        });
        updateBulkActionsBar();
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll').checked;
        document.querySelectorAll('.contract-checkbox').forEach(cb => {
            cb.checked = selectAll;
        });
        updateSelection();
    }

    function updateBulkActionsBar() {
        const bar = document.getElementById('bulkActionsBar');
        const countEl = document.getElementById('selectedCount');

        if (selectedContracts.size > 0) {
            bar.classList.remove('hidden');
            countEl.textContent = `${selectedContracts.size} contract${selectedContracts.size > 1 ? 's' : ''} selected`;
        } else {
            bar.classList.add('hidden');
        }
    }

    function clearSelection() {
        document.querySelectorAll('.contract-checkbox').forEach(cb => {
            cb.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        selectedContracts.clear();
        updateBulkActionsBar();
    }

    // ====== Bulk Operations ======
    function compareSelected() {
        if (selectedContracts.size < 2) {
            showWarning('Please select at least 2 contracts to compare');
            return;
        }
        if (selectedContracts.size > 4) {
            showWarning('You can compare up to 4 contracts at a time');
            return;
        }
        const params = Array.from(selectedContracts).map(id => `contracts=${encodeURIComponent(id)}`).join('&');
        window.location.href = `/compare?${params}`;
    }

    let bulkStatusTrigger = null;

    function bulkUpdateStatus() {
        bulkStatusTrigger = document.activeElement;
        document.getElementById('bulkStatusCount').textContent = selectedContracts.size;
        openAccessibleModal('bulkStatusModal', bulkStatusTrigger);
    }

    function closeBulkStatusModal() {
        closeAccessibleModal('bulkStatusModal');
    }

    async function applyBulkStatus() {
        const newStatus = document.getElementById('bulkStatusSelect').value;
        if (!newStatus) {
            showWarning('Please select a status');
            return;
        }

        // Close the status select modal first
        closeBulkStatusModal();

        // Show confirmation dialog
        const statusLabel = document.querySelector(`#bulkStatusSelect option[value="${newStatus}"]`).textContent;
        showConfirmDialog({
            title: 'Confirm Status Update',
            message: `Are you sure you want to change the status to "${statusLabel}" for ${selectedContracts.size} contract(s)?`,
            details: `<p><strong>${selectedContracts.size}</strong> contract(s) will be updated to status: <strong>${statusLabel}</strong></p>`,
            type: newStatus === 'Cancelled' ? 'danger' : 'warning',
            confirmText: 'Update Status',
            onConfirm: async () => {
                showLoading(`Updating contracts... 0 of ${selectedContracts.size}`);

                let count = 0;
                const total = selectedContracts.size;

                for (const contractId of selectedContracts) {
                    try {
                        await fetch(`/api/contract/${contractId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: newStatus })
                        });
                        count++;
                        document.getElementById('loadingMessage').textContent = `Updating contracts... ${count} of ${total}`;
                    } catch (err) {
                        console.error('Error updating contract:', err);
                    }
                }

                hideLoading();
                window.location.reload();
            }
        });
    }

    let bulkDeptTrigger = null;

    function bulkAssignDepartment() {
        bulkDeptTrigger = document.activeElement;
        document.getElementById('bulkDeptCount').textContent = selectedContracts.size;
        openAccessibleModal('bulkDeptModal', bulkDeptTrigger);
    }

    function closeBulkDeptModal() {
        closeAccessibleModal('bulkDeptModal');
    }

    async function applyBulkDept() {
        const newDept = document.getElementById('bulkDeptSelect').value;
        if (!newDept) {
            showWarning('Please select a department');
            return;
        }

        // Close the department select modal first
        closeBulkDeptModal();

        // Show confirmation dialog
        showConfirmDialog({
            title: 'Confirm Department Assignment',
            message: `Are you sure you want to assign ${selectedContracts.size} contract(s) to "${newDept}"?`,
            details: `<p><strong>${selectedContracts.size}</strong> contract(s) will be assigned to department: <strong>${newDept}</strong></p>`,
            type: 'warning',
            confirmText: 'Assign Department',
            onConfirm: async () => {
                showLoading(`Assigning department... 0 of ${selectedContracts.size}`);

                let count = 0;
                const total = selectedContracts.size;

                for (const contractId of selectedContracts) {
                    try {
                        await fetch(`/api/contract/${contractId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ department: newDept })
                        });
                        count++;
                        document.getElementById('loadingMessage').textContent = `Assigning department... ${count} of ${total}`;
                    } catch (err) {
                        console.error('Error updating contract:', err);
                    }
                }

                hideLoading();
                window.location.reload();
            }
        });
    }

    function bulkExport() {
        const ids = Array.from(selectedContracts).join(',');
        window.location.href = `/api/export?ids=${ids}`;
    }

    // ====== Saved Searches ======
    function loadSavedSearches() {
        const searches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
        const container = document.getElementById('savedSearchesList');
        container.innerHTML = '';

        if (searches.length === 0) {
            container.innerHTML = '<span class="text-xs text-gray-400">No saved searches</span>';
            return;
        }

        searches.forEach((search, index) => {
            const tag = document.createElement('span');
            tag.className = 'inline-flex items-center px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-sm rounded-full cursor-pointer hover:bg-blue-200 dark:hover:bg-blue-800';
            tag.innerHTML = `
                <a href="?${search.params}" class="mr-1">${search.name}</a>
                <button onclick="deleteSavedSearch(${index})" class="text-blue-600 hover:text-blue-800 ml-1">&times;</button>
            `;
            container.appendChild(tag);
        });
    }

    function saveCurrentSearch() {
        const params = window.location.search.substring(1);
        if (!params) {
            showWarning('No filters applied to save');
            return;
        }

        const name = prompt('Enter a name for this search:');
        if (!name) return;

        const searches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
        searches.push({ name, params });
        localStorage.setItem('savedSearches', JSON.stringify(searches));
        loadSavedSearches();
        showSuccess(`Search "${name}" saved!`);
    }

    function deleteSavedSearch(index) {
        const searches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
        const searchName = searches[index]?.name || 'this search';

        confirmDelete('saved search', searchName, () => {
            searches.splice(index, 1);
            localStorage.setItem('savedSearches', JSON.stringify(searches));
            loadSavedSearches();
        });
    }

    // ====== Sorting ======
    function applySorting() {
        const sortBy = document.getElementById('sortBy').value;
        if (!sortBy) return;

        const currentParams = new URLSearchParams(window.location.search);
        currentParams.set('sort', sortBy);
        window.location.href = '?' + currentParams.toString();
    }

    // ====== Pagination ======
    function changePerPage(perPage) {
        const currentParams = new URLSearchParams(window.location.search);
        currentParams.set('per_page', perPage);
        currentParams.set('page', '1'); // Reset to first page when changing per_page
        window.location.href = '?' + currentParams.toString();
    }

    // ====== Auto-apply Filters with Debounce ======
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function applyFilters() {
        const form = document.querySelector('form[method="GET"]');
        if (form) {
            // Show loading indicator
            showLoading('Filtering...');
            form.submit();
        }
    }

    const debouncedApplyFilters = debounce(applyFilters, 500);

    function setupAutoFilters() {
        // Auto-apply on search input (with debounce)
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', debouncedApplyFilters);
            // Also apply on Enter key immediately
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyFilters();
                }
            });
        }

        // Auto-apply on select change (immediate)
        const statusFilter = document.getElementById('statusFilter');
        const deptFilter = document.getElementById('deptFilter');
        const healthFilter = document.getElementById('healthFilter');

        [statusFilter, deptFilter, healthFilter].forEach(select => {
            if (select) {
                select.addEventListener('change', applyFilters);
            }
        });
    }

    // ====== Preference Persistence ======
    function saveContractFilters() {
        const filters = {
            status: document.getElementById('statusFilter')?.value || '',
            department: document.getElementById('deptFilter')?.value || '',
            health: document.getElementById('healthFilter')?.value || ''
        };
        setPagePreference('contracts', 'filters', filters);
    }

    function saveContractPerPage(perPage) {
        setPagePreference('contracts', 'perPage', perPage);
    }

    function loadContractPreferences() {
        // Only apply saved preferences if there are no URL params (fresh visit)
        const urlParams = new URLSearchParams(window.location.search);
        const hasUrlFilters = urlParams.has('status') || urlParams.has('department') ||
                              urlParams.has('health') || urlParams.has('search');

        if (!hasUrlFilters) {
            // Load saved filters
            const savedFilters = getPagePreference('contracts', 'filters', null);
            if (savedFilters) {
                const statusFilter = document.getElementById('statusFilter');
                const deptFilter = document.getElementById('deptFilter');
                const healthFilter = document.getElementById('healthFilter');

                let hasFilters = false;
                if (savedFilters.status && statusFilter) {
                    statusFilter.value = savedFilters.status;
                    hasFilters = hasFilters || savedFilters.status !== '';
                }
                if (savedFilters.department && deptFilter) {
                    deptFilter.value = savedFilters.department;
                    hasFilters = hasFilters || savedFilters.department !== '';
                }
                if (savedFilters.health && healthFilter) {
                    healthFilter.value = savedFilters.health;
                    hasFilters = hasFilters || savedFilters.health !== '';
                }

                // Apply filters if any were loaded
                if (hasFilters) {
                    applyFilters();
                }
            }

            // Load saved per page preference
            const savedPerPage = getPagePreference('contracts', 'perPage', null);
            if (savedPerPage) {
                const perPageSelect = document.querySelector('select[onchange*="changePerPage"]');
                if (perPageSelect && perPageSelect.value !== savedPerPage.toString()) {
                    changePerPage(savedPerPage);
                }
            }
        }
    }

    function setupPreferenceSaving() {
        // Save filters when they change
        const statusFilter = document.getElementById('statusFilter');
        const deptFilter = document.getElementById('deptFilter');
        const healthFilter = document.getElementById('healthFilter');

        [statusFilter, deptFilter, healthFilter].forEach(select => {
            if (select) {
                select.addEventListener('change', saveContractFilters);
            }
        });

        // Save per page preference
        const perPageSelect = document.querySelector('select[onchange*="changePerPage"]');
        if (perPageSelect) {
            perPageSelect.addEventListener('change', function() {
                saveContractPerPage(this.value);
            });
        }
    }

    // ====== Initialize ======
    document.addEventListener('DOMContentLoaded', function() {
        loadSavedSearches();
        setupAutoFilters();
        setupPreferenceSaving();
        loadContractPreferences();
        loadMobileViewPreference();

        // Setup accessible modal backdrop close handlers
        setupModalBackdropClose('bulkStatusModal', closeBulkStatusModal);
        setupModalBackdropClose('bulkDeptModal', closeBulkDeptModal);
    });
</script>
{% endblock %}

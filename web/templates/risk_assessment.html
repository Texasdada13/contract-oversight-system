{% extends "base.html" %}

{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Contract Risk Assessment</h1>
        <p class="text-gray-500 dark:text-gray-400">Analyze and monitor contract risk factors</p>
    </div>
    <div class="flex space-x-3">
        <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            Export Report
        </button>
    </div>
</div>

<!-- Summary Stats -->
<div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow p-4 text-white">
        <p class="text-red-100 text-xs">Critical Risk</p>
        <p class="text-3xl font-bold">{{ summary.critical_count }}</p>
    </div>
    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow p-4 text-white">
        <p class="text-orange-100 text-xs">High Risk</p>
        <p class="text-3xl font-bold">{{ summary.high_count }}</p>
    </div>
    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow p-4 text-white">
        <p class="text-yellow-100 text-xs">Medium Risk</p>
        <p class="text-3xl font-bold">{{ summary.medium_count }}</p>
    </div>
    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow p-4 text-white">
        <p class="text-green-100 text-xs">Low Risk</p>
        <p class="text-3xl font-bold">{{ summary.low_count }}</p>
    </div>
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow p-4 text-white">
        <p class="text-purple-100 text-xs">Avg Risk Score</p>
        <p class="text-3xl font-bold">{{ summary.avg_risk|int }}</p>
    </div>
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow p-4 text-white">
        <p class="text-blue-100 text-xs">At Risk Value</p>
        <p class="text-2xl font-bold">${{ '{:,.0f}'.format(summary.total_at_risk_value) }}</p>
    </div>
</div>

<!-- Risk Distribution Charts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Risk Distribution</h3>
        <div id="riskDistChart" style="height: 250px;"></div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Risk by Department</h3>
        <div id="deptRiskChart" style="height: 250px;"></div>
    </div>
</div>

<!-- Risk Matrix -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
    <div class="px-6 py-4 border-b dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Risk Factor Analysis</h3>
        <p class="text-sm text-gray-500">Breakdown of risk factors for each contract</p>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg text-center">
                <p class="text-2xl font-bold text-blue-600">35%</p>
                <p class="text-sm text-gray-600 dark:text-gray-300">Budget Risk Weight</p>
            </div>
            <div class="p-4 bg-purple-50 dark:bg-purple-900/30 rounded-lg text-center">
                <p class="text-2xl font-bold text-purple-600">30%</p>
                <p class="text-sm text-gray-600 dark:text-gray-300">Schedule Risk Weight</p>
            </div>
            <div class="p-4 bg-orange-50 dark:bg-orange-900/30 rounded-lg text-center">
                <p class="text-2xl font-bold text-orange-600">20%</p>
                <p class="text-sm text-gray-600 dark:text-gray-300">Vendor Risk Weight</p>
            </div>
            <div class="p-4 bg-green-50 dark:bg-green-900/30 rounded-lg text-center">
                <p class="text-2xl font-bold text-green-600">15%</p>
                <p class="text-sm text-gray-600 dark:text-gray-300">Compliance Risk Weight</p>
            </div>
        </div>
    </div>
</div>

<!-- Risk Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow">
    <div class="px-6 py-4 border-b dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Contract Risk Assessment</h3>
        <div class="flex space-x-2">
            <input type="text" id="riskSearch" placeholder="Search contracts..." onkeyup="filterRisks()"
                class="px-3 py-2 border rounded-lg text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <select id="riskFilter" onchange="filterRisks()"
                class="px-3 py-2 border rounded-lg text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">All Risk Levels</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700" id="riskTable">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Contract</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Department</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Value</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Budget</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Schedule</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Vendor</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Compliance</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Overall Risk</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for risk in risk_data %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 risk-row"
                    data-name="{{ risk.title|lower }}"
                    data-level="{{ risk.risk_level }}">
                    <td class="px-4 py-4">
                        <a href="{{ url_for('contract_detail', contract_id=risk.contract_id) }}" class="text-blue-600 hover:underline font-medium">
                            {{ risk.title[:40] }}{% if risk.title|length > 40 %}...{% endif %}
                        </a>
                        <p class="text-xs text-gray-500">{{ risk.vendor_name }}</p>
                    </td>
                    <td class="px-4 py-4 text-sm text-gray-600 dark:text-gray-300">{{ risk.department }}</td>
                    <td class="px-4 py-4 text-sm font-medium text-gray-800 dark:text-white">${{ '{:,.0f}'.format(risk.current_amount) }}</td>
                    <td class="px-4 py-4 text-center">
                        <div class="inline-flex items-center">
                            <div class="w-12 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full {% if risk.budget_risk >= 70 %}bg-red-500{% elif risk.budget_risk >= 50 %}bg-orange-500{% elif risk.budget_risk >= 30 %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                                    style="width: {{ risk.budget_risk }}%"></div>
                            </div>
                            <span class="text-xs">{{ risk.budget_risk|int }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="inline-flex items-center">
                            <div class="w-12 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full {% if risk.schedule_risk >= 70 %}bg-red-500{% elif risk.schedule_risk >= 50 %}bg-orange-500{% elif risk.schedule_risk >= 30 %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                                    style="width: {{ risk.schedule_risk }}%"></div>
                            </div>
                            <span class="text-xs">{{ risk.schedule_risk|int }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="inline-flex items-center">
                            <div class="w-12 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full {% if risk.vendor_risk >= 70 %}bg-red-500{% elif risk.vendor_risk >= 50 %}bg-orange-500{% elif risk.vendor_risk >= 30 %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                                    style="width: {{ risk.vendor_risk }}%"></div>
                            </div>
                            <span class="text-xs">{{ risk.vendor_risk|int }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="inline-flex items-center">
                            <div class="w-12 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full {% if risk.compliance_risk >= 70 %}bg-red-500{% elif risk.compliance_risk >= 50 %}bg-orange-500{% elif risk.compliance_risk >= 30 %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                                    style="width: {{ risk.compliance_risk }}%"></div>
                            </div>
                            <span class="text-xs">{{ risk.compliance_risk|int }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <span class="text-xl font-bold mr-2
                                {% if risk.risk_level == 'Critical' %}text-red-600
                                {% elif risk.risk_level == 'High' %}text-orange-600
                                {% elif risk.risk_level == 'Medium' %}text-yellow-600
                                {% else %}text-green-600{% endif %}">
                                {{ risk.overall_risk|int }}
                            </span>
                            <span class="px-2 py-1 text-xs font-medium rounded
                                {% if risk.risk_level == 'Critical' %}bg-red-100 text-red-800
                                {% elif risk.risk_level == 'High' %}bg-orange-100 text-orange-800
                                {% elif risk.risk_level == 'Medium' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ risk.risk_level }}
                            </span>
                        </div>
                        {% if risk.days_overdue > 0 %}
                        <p class="text-xs text-red-600 mt-1">{{ risk.days_overdue }} days overdue</p>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Department Risk Summary -->
<div class="mt-8 bg-white dark:bg-gray-800 rounded-lg shadow">
    <div class="px-6 py-4 border-b dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Risk by Department</h3>
    </div>
    <div class="p-6">
        <div class="space-y-4">
            {% for dept in department_risks %}
            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div>
                    <p class="font-medium text-gray-800 dark:text-white">{{ dept.name }}</p>
                    <p class="text-sm text-gray-500">{{ dept.contracts }} contracts - ${{ '{:,.0f}'.format(dept.value) }}</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="w-32 bg-gray-200 dark:bg-gray-600 rounded-full h-3">
                        <div class="h-3 rounded-full
                            {% if dept.avg_risk >= 70 %}bg-red-500
                            {% elif dept.avg_risk >= 50 %}bg-orange-500
                            {% elif dept.avg_risk >= 30 %}bg-yellow-500
                            {% else %}bg-green-500{% endif %}"
                            style="width: {{ dept.avg_risk }}%"></div>
                    </div>
                    <span class="text-lg font-bold
                        {% if dept.avg_risk >= 70 %}text-red-600
                        {% elif dept.avg_risk >= 50 %}text-orange-600
                        {% elif dept.avg_risk >= 30 %}text-yellow-600
                        {% else %}text-green-600{% endif %}">
                        {{ dept.avg_risk|int }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Risk Distribution Chart
    Plotly.newPlot('riskDistChart', [{
        type: 'pie',
        labels: ['Critical', 'High', 'Medium', 'Low'],
        values: [{{ summary.critical_count }}, {{ summary.high_count }}, {{ summary.medium_count }}, {{ summary.low_count }}],
        hole: 0.4,
        marker: {
            colors: ['#EF4444', '#F97316', '#EAB308', '#22C55E']
        },
        textinfo: 'label+value'
    }], {
        margin: { t: 20, b: 20, l: 20, r: 20 },
        showlegend: false
    }, { responsive: true });

    // Department Risk Chart
    const deptData = {{ department_risks | tojson | safe }};
    Plotly.newPlot('deptRiskChart', [{
        type: 'bar',
        x: deptData.map(d => d.name),
        y: deptData.map(d => d.avg_risk),
        marker: {
            color: deptData.map(d => {
                if (d.avg_risk >= 70) return '#EF4444';
                if (d.avg_risk >= 50) return '#F97316';
                if (d.avg_risk >= 30) return '#EAB308';
                return '#22C55E';
            })
        }
    }], {
        margin: { t: 20, b: 80, l: 40, r: 20 },
        yaxis: { title: 'Avg Risk Score', range: [0, 100] }
    }, { responsive: true });

    // Filter risks
    function filterRisks() {
        const searchTerm = document.getElementById('riskSearch').value.toLowerCase();
        const levelFilter = document.getElementById('riskFilter').value;
        const rows = document.querySelectorAll('.risk-row');

        rows.forEach(row => {
            const name = row.dataset.name;
            const level = row.dataset.level;

            let showBySearch = name.includes(searchTerm);
            let showByLevel = !levelFilter || level === levelFilter;

            row.style.display = (showBySearch && showByLevel) ? '' : 'none';
        });
    }
</script>
{% endblock %}
